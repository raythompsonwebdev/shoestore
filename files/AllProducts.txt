import React, { useState, useEffect } from "react";
import ProductBoxes from "../components/Product/productBoxes";
import FindShoesAccord from "../components/FindShoesAccord";
import SearchBar from "../components/SearchBar/SearchBar";
import SearchSelect from "../components/SearchSelect/SearchSelect";

function AllProducts() {
  const [productData, setProductData] = useState([]);
  const [orderDir, setOrderByDir] = useState("asc");
  const [OrderByVal, setOrderByVal] = useState("all");
  const [lastIndex, setLastIndex] = useState(0);
  const [visibility, setVisibility] = useState(false);
  const [searchData, setSearchData] = useState([]);
  const [selectData, setSelectData] = useState([]);

  useEffect(() => {
    // const fetchProducts = fetch(`/api/products/`);
    // const fetchProducts = fetch(`./productdata.json`);

    // get products
    const getProducts = fetch("/api/products");

    // get search bar options data
    const getSearchData = fetch("/api/searchbardata");

    // get select bar options data
    const getSelectData = fetch("/api/selectdata");

    // Use promise all to get data for both apis
    // promise all accepts array.
    Promise.all([getProducts, getSearchData, getSelectData])
      .then((values) =>
        // convert returned promises to json data by passing promises (which are arrays) into promise.all again and looping over arrays and apply .json() to each element of the array then return an array as json data.
        Promise.all(values.map((element) => element.json()))
      )
      .then(([productdata, searchedData, selectedData]) => {
        // deconstruct array of data from both apis responses.
        // eslint-disable-next-line no-console
        // console.log(productdata, searchData, selectData);
        const productDataResult = productdata.map((shoe, index) => {
          // eslint-disable-next-line react/destructuring-assignment
          setLastIndex(index);
          // this.setState({ lastIndex: index });
          // eslint-disable-next-line no-param-reassign
          shoe.prodId = lastIndex;

          return shoe;
        });
        setProductData(productDataResult);
        setSearchData(searchedData);
        setSelectData(selectedData);
      })
      .catch((error) => {
        // eslint-disable-next-line no-console
        console.error(error);
        throw new Error("something went wrong");
      });
  });

  const handleChange = (selectedSize) => {
    setOrderByVal(selectedSize);
    setOrderByDir("asc");
  };

  const sidebarVisibility = (e) => {
    e.preventDefault();
    // const { visibility } = { ...this.state };
    setVisibility(!visibility);
  };

  const changesOrders = (orderbyval, dir) => {
    setOrderByVal(orderbyval);
    setOrderByDir(dir);
    // this.setState({
    //   orderByVal: orderbyval,
    //   orderDir: dir,
    // });
  };

  // const {
  //   productData,
  //   orderDir,
  //   orderByVal,
  //   visibility,
  //   searchData,
  //   selectData,
  // } = {
  //   ...this.state,
  // };
  let filteredApts = productData;
  const value = OrderByVal;

  filteredApts = filteredApts.filter((item) => {
    if (
      item.color === value ||
      item.style === value ||
      item.size === value ||
      item.gender === value ||
      item.price === value
    ) {
      return item;
    }
    return item[value];
  });

  return (
    <main id="content" className="clearfix">
      <SearchBar
        labelname="All Products"
        orderByVal={OrderByVal}
        orderDir={orderDir}
        // changesOrders={changesOrders}
        // handleChange={handleChange}
        searchData={searchData}
      />

      <button
        id="sidebar-toggle-btn"
        type="button"
        onClick={sidebarVisibility}
        aria-label="secondary menu toggle button"
      >
        SIDE
      </button>

      <aside className={`left_bar ${visibility ? "is-expanded" : " "}`}>
        <FindShoesAccord />
      </aside>

      <main id="content_section" className="group">
        <SearchSelect
          orderByVal={OrderByVal}
          orderDir={orderDir}
          changesOrders={changesOrders}
          handleChange={handleChange}
          selectData={selectData}
        />
        <ProductBoxes productData={filteredApts} />
      </main>
    </main>
  );
}

export default AllProducts;
